<!--
 * Copyright (c) 2009 The Australian National University.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Apache License v2.0.
 * You may obtain the license at
 * 
 *    http://www.opensource.org/licenses/apache2.0.php
 -->
<project name="DacapoAgent" default="all" basedir="..">
	<description>DaCapo Agent</description>

	<import file="../util.xml"/>
	
	<property name="agentdir" value="${basedir}/agent"/>
	<property name="dist-dir" value="${agentdir}/dist"/>
	
	<property file="dacapo.properties"/>

	<condition property="linux">
		<equals arg1="${os.name}" arg2="linux" casesensitive="no" trim="yes"/>
	</condition>

	<property name="download-dir" value="${agentdir}/download"/>
	<property name="asm-verison" value="3.2"/>
	<property name="asm-jar" value="asm-${asm-verison}.jar"/>
	<property name="asm-url" value="http://download.forge.objectweb.org/asm"/>
	
	<property name="make" value="make"/>

	<target name="init">
		<mkdir dir="${agentdir}/build"/>
		<mkdir dir="${agentdir}/lib"/>
		<mkdir dir="${dist-dir}"/>
	</target>

	<target name="libs" depends="init">
		<antcall target="check-source">
			<param name="target-file" value="${asm-jar}" />
			<param name="target-dir"  value="${download-dir}" />
			<param name="target-url"  value="${asm-url}"/>
		</antcall>
		<copy file="${download-dir}/${asm-jar}" tofile="${dist-dir}/${asm-jar}"/>
	</target>
	
	<target name="all" depends="init,libs,jar,build-agent-linux">
	</target>
		
	<target name="jar">
		<javac srcdir="${agentdir}/src" destdir="${agentdir}/build" classpath="${dist-dir}/${asm-jar}" />
		<jar destfile="${agentdir}/dist/agent.jar" basedir="${agentdir}/build" />
	</target>
	
	<target name="build-agent-linux" if="linux">
		<exec executable="${make}" dir="agent">
			<arg value="JAVA_HOME=${java.home}/.."/>
			<arg value="OSNAME=linux"/>
		</exec>
	</target>

	<target name="clean">
		<exec executable="${make}" dir="agent">
			<arg value="JAVA_HOME=${java.home}"/>
			<arg value="clean"/>
		</exec>
		<delete dir="${dist-dir}"/>
		<delete dir="${agentdir}/lib"/>
		<delete dir="${agentdir}/build"/>
	</target>

</project>

